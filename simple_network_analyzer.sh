#!/bin/bash

help="Usage: Option -b bro analysis only. Option -t tshark analysis only. Option -bt broth analysis. <path to bro folder> <path to pcap>"

if [ $# -lt 2 ]; then
    echo $help
    exit 1
fi

setup(){
    #Create a results folder
    result_folder="sna_results"
    if [ -d $result_folder ]; then
        rm -rf $result_folder
    fi
    mkdir $result_folder
    echo "Created result folder at $(pwd)/$result_folder"
    echo "Analysis started at $(date)" >  $(pwd)/$result_folder/sna.log
}

bro_analysis(){
    echo "Starting bro analysis . . . "

    echo "Starting: List the connections by in increasing order of duration, i.e., the longest connections at the end"
    echo "List the connections by in increasing order of duration, i.e., the longest connections at the end" > $result_folder/duration.log 
    awk 'NR > 4' < $1/conn.log | sort -t$'\t' -k 9 -n > $result_folder/duration.log

    echo "Starting: Show a breakdown of the number of connections by service."
    echo "Show a breakdown of the number of connections by service." > $result_folder/services.log
    bro-cut service < $1/conn.log | sort | uniq -c | sort -n > $result_folder/services.log

    echo "Starting: Find the conversations longer than 60 seconds"
    echo "Find the conversations longer than 60 seconds" > $result_folder/longer_60.log
    awk 'NR > 4 && $9 > 60' $1/conn.log > $result_folder/longer_60.log

    echo "Starting: Find all IP addresses of web servers that send more than more than 1 KB back to a client"
    echo "Find all IP addresses of web servers that send more than more than 1 KB back to a client." > $result_folder/web_servers_download.log
    bro-cut service resp_bytes id.resp_h < $1/conn.log | awk '$1 == "http" && $2 > 1000 { print $3 }' | sort -u > $result_folder/web_servers_download.log

    echo "Starting: Show the top 10 destination ports in descending order"
    echo "Show the top 10 destination ports in descending order." > $result_folder/ports10.log 
    bro-cut id.resp_p < $1/conn.log | sort | uniq -c | sort -rn | head -n 10 > $result_folder/ports10.log

    echo "Starting: What are the three most commonly accessed web sites?"
    echo "What are the three most commonly accessed web sites?" > $result_folder/web_sites3.log
    bro-cut host < $1/http.log | sort | uniq -c | sort -n | tail -n 3 > $result_folder/web_sites3.log

    echo "Bro analysis done!"
}

tshark_analysis(){
    echo "Starting tshark analysis . . . "

    echo "Search data payloads and data lengths" > $result_folder/payloads.log
    tshark -r $1 -T fields -E separator=, -e ip.src -e tcp.srcport -e ip.dst -e tcp.dstport -e data -e data.len | sort -n | uniq -c > $result_folder/payloads.log

    echo "Tshark analysis done!"
}


if [ $1 == "-b" ]; then
    echo "Selected bro analysis only"
    if [ ! -d $2 ]; then
        echo "$2 not a bro directory. Please Specify a valid bro directory path"
        exit 2
    else
        setup
        bro_analysis $2
        echo "Analysis ended at $(date)" >>  $(pwd)/$result_folder/sna.log
        exit 0
    fi

    if [ $1 == "-t" ]; then
        echo "Selected tshark analysis only"
        if [ ! -f $2 ]; then
            echo "$2 not a pcap file . Please Specify a valid pcap file path"
            exit 3
        else
            setup
            tshark_analysis $2
            echo "Analysis ended at $(date)" >>  $(pwd)/$result_folder/sna.log
            exit 0
        fi
    fi

    if [ $1 == "-bt" ]; then
        echo "Selected both bro and tshark analysis"
        if [ ! -d $2 ]; then
            echo "$2 not a bro directory. Please Specify a valid bro directory path"
            exit 4
        fi

        if [ ! -f $3 ]; then
            echo "$3 not a pcap file . Please Specify a valid pcap file path"
            exit 5
        fi

        setup
        bro_analysis $2
        tshark_analysis $3
        echo "Analysis ended at $(date)" >>  $(pwd)/$result_folder/sna.log
        exit 0
    fi

fi

