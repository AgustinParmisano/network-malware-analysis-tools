#!/bin/bash

help_msg="Usage: first argument conn.log file second argument labels.csv configuration file"

if [ $# -lt 1 ]; then
    echo $help_msg
    exit 1
fi

if [ ! -f $1 ]; then
    echo "First argument is not a valid file path"
    echo $help_msg
    exit 2
fi

connlog_file=$1

if [ $# -gt 1 ]; then 
    labels_csv_file=$2
else
    labels_csv_file=$(echo "${connlog_file/conn.log/labels.csv}")
    echo "Using default label file $labels_csv_file"
fi

echo "Starting flaber.py: fast labeler script"
python3 flaber.py $connlog_file $labels_csv_file
echo "flaber.py script terminated"
echo "Starting bro_column_adder.py script"
python3 bro_column_adder.py $connlog_file out.csv
echo "bro_column_adder.py terminated"

if [ $(tail -1 $connlog_file | grep -c close) -eq 1 ]; then
    tail -1 $connlog_file >> "$connlog_file.labeled" 
fi

rm out.csv
exit 0