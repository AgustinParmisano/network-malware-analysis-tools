#!/bin/bash

help_msg="Usage: first argument conn.log file second argument labels.csv configuration file"
log_file="flaber_adder_launcher.log"

echo "Starting flaber_adder_launcher.sh" 
echo "Logs at $log_file"
echo "Started flaber_adder_launcher.sh at $(date) with file $connlog_file"
echo "Started flaber_adder_launcher.sh at $(date) with file $connlog_file" >> $log_file

if [ $# -lt 1 ]; then
    echo $help_msg
    exit 1
fi

if [ ! -f $1 ]; then
    echo "First argument is not a valid file path"
    echo $help_msg
    exit 2
fi

connlog_file=$1

if [ $# -gt 1 ]; then 
    labels_csv_file=$2
else
    labels_csv_file=$(echo "${connlog_file/conn.log/labels.csv}")
    echo "Using default label file $labels_csv_file"
fi

echo "Starting flaber.py: fast labeler script"
python3 flaber.py $connlog_file $labels_csv_file
echo "flaber.py script terminated"
echo "Starting bro_column_adder.py script"
python3 bro_column_adder.py $connlog_file out.csv
echo "bro_column_adder.py terminated"

if [ $(tail -1 $connlog_file | grep -c close) -eq 1 ]; then
    tail -1 $connlog_file >> "$connlog_file.labeled" 
fi

labels=($(cat $labels_csv_file | cut -d"," -f6 | sort | uniq | awk 'NF > 0'))

warnings=0
for i in ${labels[*]}; do
    if [ $i != "Label" ]; then
        if [ $(cat $connlog_file.labeled | awk '{print $23}' | grep -c "$i") -eq 0 ]; then
            echo "WARNING: $connlog_file.labeled does not have any of $i labels"
            echo "WARNING: $connlog_file.labeled does not have any of $i labels" >> $log_file
            warnings=$((warning + 1))
        fi
    fi
done

rm out.csv

original_rows=$(wc -l $connlog_file)
labeled_rows=$(wc -l $connlog_file.labeled)

if [ $original_rows -ne $labeled_rows ]; then
    echo "ERROR: Number of rows missmatch - file $connlog_file has $original_rows and file $connlog_file.labeled has $labeled_rows"
    echo "ERROR: Number of rows missmatch - file $connlog_file has $original_rows and file $connlog_file.labeled has $labeled_rows" >> $log_file
fi

echo "Finished flaber_adder_launcher.sh at $(date) with file $connlof_file with $warnings warnings"
echo "Finished flaber_adder_launcher.sh at $(date) with file $connlof_file with $warnings warnings" >> $log_file

if [ $warnings -gt 0 ]; then
    echo "See the $warnings warnings at $log_file"
fi

exit 0