#!/bin/bash

if [ $# -ne 1 ]; then
    echo "Need bro conn.log path argument."
    exit 1
fi

connlog=$1
echo "Get the top 10 most used ports"
ports_top10=($(bro-cut id.resp_p < $connlog | sort | uniq | sort -rn | head -n 10))

for i in ${ports_top10[*]}; do
    split_file="port_$i.log"
    echo "Creating port $split_file split file"
    touch $split_file
    bro-cut -n < $connlog | awk '$6 == '$i' { print $0 }' > "port_$i.log"
done

echo "Running splitter.sh script on the generated ports split files."
./splitter.sh $connlog
#echo "Running zeek_anomaly_detector.py on the generated test_split.log file"
python3 zeek_anomaly_detector.py -a 10 -f test_split.log > anomaly_detector.txt

#echo "Running labeled_dataframe_assigner.py on the generated test_split.log file"
python3 labeled_dataframe_assigner.py test_split.log

exit 0