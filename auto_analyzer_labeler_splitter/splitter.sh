#!/bin/bash 

top=20000
ports=$(ls | grep -c port)
top_per_port=$(($top / $ports))

if [ $# -ne 1 ]; then
    echo "Need bro conn.log file as argument"
    exit 1
fi

echo "Got $ports port log files"
for f in $(ls | grep port); do
    echo "Splitting file $f"
    cant=$(cat $f | awk '{ print $0 }' | wc -l)
    echo "File $f has $cant lines "
   
    max=$cant
    
    if [ $max -ge $top_per_port ]; then
        echo "$max lines in file $f is greather than top per port $top_per_port so will be restricted to that top"    
        max=$top_per_port
    fi 
    
    echo "Splitting file $f with maximun $max flows"
    cat $f | awk '{ print $0 }' | shuf -n $max >> test_split.log
done    

echo "Getting uniques"
sort -u test_split.log > test_split.log.backup


echo "Shuffling until get $top lines"
shuf -n $top test_split.log.backup > test_split.log
result=$(cat test_split.log | wc -l )
while [ $result -lt $top ]; do
    echo "Shuffling the result with lines $result until get $top lines"
    shuf -n $top test_split.log.backup > test_split.log
    result=$(wc -l test_split.log)
done

head -8 $1 > test_split.log.backup
cat test_split.log >> test_split.log.backup
cp test_split.log.backup test_split.log
result=$(wc -l test_split.log)
echo "The result file has $result lines"
exit 0
